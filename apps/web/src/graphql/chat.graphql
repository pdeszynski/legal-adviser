# GraphQL Operations for Chat Module
# Contains queries and mutations for legal Q&A functionality

# Fragment for LegalQuery fields - reused across queries and mutations
fragment LegalQueryFragment on LegalQuery {
  id
  question
  answerMarkdown
  citations {
    source
    url
    excerpt
    article
  }
  sessionId
  createdAt
  updatedAt
}

# Mutation: Ask a legal question and get AI answer synchronously
mutation AskLegalQuestion($input: AskLegalQuestionInput!) {
  askLegalQuestion(input: $input) {
    ...LegalQueryFragment
  }
}

# Query: Get a single legal query by ID
query GetLegalQuery($id: ID!) {
  legalQuery(id: $id) {
    ...LegalQueryFragment
  }
}

# Query: Get all queries for a specific session (for chat history)
# Uses the queriesBySession field from the Query type
query GetSessionQueries($sessionId: String!) {
  queriesBySession(sessionId: $sessionId) {
    ...LegalQueryFragment
  }
}

# Query: Get pending queries (queries without answers)
query GetPendingQueries {
  pendingQueries {
    ...LegalQueryFragment
  }
}

# Clarification Session Fragment
fragment ClarificationSessionFragment on ClarificationSession {
  id
  state
  originalQuery
  questionsAsked
  answersReceived {
    question
    answer
    question_type
  }
  rounds
  accumulatedContext
  finalQueryId
  completedAt
  expiresAt
  createdAt
  updatedAt
}

# Mutation: Submit answers to clarification questions
mutation SubmitClarificationAnswers($input: SubmitClarificationAnswersInput!) {
  submitClarificationAnswers(input: $input) {
    success
    clarificationMessageId
    validationErrors {
      code
      message
      questionId
    }
    userMessage {
      messageId
      role
      content
      sequenceOrder
      createdAt
    }
  }
}

# Mutation: Cancel an active clarification session
mutation CancelClarificationSession($input: CancelClarificationSessionInput!) {
  cancelClarificationSession(input: $input) {
    ...ClarificationSessionFragment
  }
}

# Query: Get active clarification session for a query
query GetClarificationSessionByQuery($queryId: String!) {
  clarificationSessionByQuery(queryId: $queryId) {
    ...ClarificationSessionFragment
  }
}

# Fragment for ChatMessage fields
fragment ChatMessageFragment on ChatMessage {
  messageId
  sessionId
  role
  content
  rawContent
  citations {
    source
    url
    article
    excerpt
  }
  metadata {
    confidence
    model
    queryType
    keyTerms
    language
  }
  sequenceOrder
  createdAt
}

# Fragment for ChatSession fields
fragment ChatSessionFragment on ChatSession {
  id
  title
  mode
  messageCount
  lastMessageAt
  createdAt
  updatedAt
  isPinned
  deletedAt
}

# Query: Get chat messages for a session (for message restoration)
query GetChatMessages($sessionId: ID!) {
  chatMessages(sessionId: $sessionId) {
    ...ChatMessageFragment
  }
}

# Query: Get chat session detail (without messages - use chatMessages for that)
query GetChatSession($sessionId: ID!) {
  chatSessionDetail(sessionId: $sessionId) {
    ...ChatSessionFragment
  }
}

# Query: Get chat sessions list for the current user
query GetChatSessions(
  $limit: Int = 20
  $offset: Int = 0
  $sortBy: String = "lastMessageAt"
  $sortOrder: String = "DESC"
  $mode: ChatMode
  $isPinned: Boolean
  $search: String
  $includeDeleted: Boolean = false
) {
  chatSessions(
    limit: $limit
    offset: $offset
    sortBy: $sortBy
    sortOrder: $sortOrder
    mode: $mode
    isPinned: $isPinned
    search: $search
    includeDeleted: $includeDeleted
  ) {
    ...ChatSessionFragment
  }
}
