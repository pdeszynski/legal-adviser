# ============================================================================
# Custom Prometheus Alert Rules for Temporal Application Metrics
# ============================================================================
#
# These alerts use the custom metrics exported by TemporalMetricsService:
# - temporal_workflows_started_total
# - temporal_workflows_completed_total
# - temporal_workflows_failed_total
# - temporal_workflows_canceled_total
# - temporal_workflows_timed_out_total
# - temporal_activities_executed_total
# - temporal_activities_failed_total
# - temporal_workflow_execution_duration_seconds
# - temporal_activity_execution_latency_seconds
# - temporal_active_workflows
# - temporal_pending_activities
# - temporal_task_queue_backlog
#
# ============================================================================

groups:
  - name: temporal_application_alerts
    interval: 30s
    rules:
      # Application workflow failure rate
      - alert: ApplicationWorkflowFailureRateHigh
        expr: |
          rate(temporal_workflows_failed_total[5m]) /
          (rate(temporal_workflows_completed_total[5m]) + rate(temporal_workflows_failed_total[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
          component: temporal-application
        annotations:
          summary: 'Application workflow failure rate is high'
          description: |
            More than 10% of workflows are failing in the application layer.
            Workflow Type: {{ $labels.workflow_type }}
            Task Queue: {{ $labels.task_queue }}

      # Critical workflow failure rate
      - alert: ApplicationWorkflowFailureRateCritical
        expr: |
          rate(temporal_workflows_failed_total[5m]) /
          (rate(temporal_workflows_completed_total[5m]) + rate(temporal_workflows_failed_total[5m])) > 0.25
        for: 2m
        labels:
          severity: critical
          component: temporal-application
        annotations:
          summary: 'CRITICAL: Application workflow failure rate'
          description: |
            More than 25% of workflows are failing. Immediate investigation required.
            Workflow Type: {{ $labels.workflow_type }}
            Task Queue: {{ $labels.task_queue }}

      # Activity failure rate high
      - alert: ApplicationActivityFailureRateHigh
        expr: |
          rate(temporal_activities_failed_total[5m]) /
          (rate(temporal_activities_executed_total[5m]) + rate(temporal_activities_failed_total[5m])) > 0.15
        for: 5m
        labels:
          severity: warning
          component: temporal-application
        annotations:
          summary: 'Application activity failure rate is high'
          description: |
            More than 15% of activities are failing.
            Activity Type: {{ $labels.activity_type }}
            Workflow Type: {{ $labels.workflow_type }}
            Task Queue: {{ $labels.task_queue }}

      # Workflow execution duration high
      - alert: WorkflowExecutionDurationHigh
        expr: |
          histogram_quantile(0.95,
            sum(rate(temporal_workflow_execution_duration_seconds_bucket[5m])) by (workflow_type, le)
          ) > 3600
        for: 10m
        labels:
          severity: warning
          component: temporal-application
        annotations:
          summary: 'Workflow execution duration is high'
          description: |
            P95 workflow execution time is above 1 hour.
            Workflow Type: {{ $labels.workflow_type }}

      # Activity latency high
      - alert: ActivityExecutionLatencyHigh
        expr: |
          histogram_quantile(0.95,
            sum(rate(temporal_activity_execution_latency_seconds_bucket[5m])) by (activity_type, le)
          ) > 300
        for: 5m
        labels:
          severity: warning
          component: temporal-application
        annotations:
          summary: 'Activity execution latency is high'
          description: |
            P95 activity execution time is above 5 minutes.
            Activity Type: {{ $labels.activity_type }}

      # Too many active workflows
      - alert: ActiveWorkflowsCountHigh
        expr: |
          temporal_active_workflows > 10000
        for: 10m
        labels:
          severity: warning
          component: temporal-application
        annotations:
          summary: 'High number of active workflows'
          description: |
            More than 10,000 active workflows detected.
            Task Queue: {{ $labels.task_queue }}

      # Task queue backlog high
      - alert: TaskQueueBacklogHigh
        expr: |
          temporal_task_queue_backlog > 1000
        for: 5m
        labels:
          severity: warning
          component: temporal-application
        annotations:
          summary: 'Task queue backlog is high'
          description: |
            Task queue has more than 1,000 pending workflow tasks.
            Task Queue: {{ $labels.task_queue }}

      # Critical task queue backlog
      - alert: TaskQueueBacklogCritical
        expr: |
          temporal_task_queue_backlog > 5000
        for: 2m
        labels:
          severity: critical
          component: temporal-application
        annotations:
          summary: 'CRITICAL: Task queue backlog is critical'
          description: |
            Task queue has more than 5,000 pending workflow tasks.
            Immediate action required to scale workers.
            Task Queue: {{ $labels.task_queue }}

      # Stuck activities detected (sent from observability service)
      - alert: StuckActivitiesDetected
        expr: |
          rate(temporal_activities_failed_total{failure_reason="Stuck activity"}[5m]) > 0
        for: 1m
        labels:
          severity: critical
          component: temporal-application
        annotations:
          summary: 'Stuck activities detected'
          description: |
            Activities have been marked as stuck (running longer than threshold).
            Activity Type: {{ $labels.activity_type }}
            Task Queue: {{ $labels.task_queue }}

      # No workflow completion
      - alert: NoWorkflowCompletions
        expr: |
          rate(temporal_workflows_completed_total[15m]) == 0
        and
          rate(temporal_workflows_started_total[15m]) > 0
        for: 15m
        labels:
          severity: critical
          component: temporal-application
        annotations:
          summary: 'Workflows are starting but not completing'
          description: |
            Workflows have been started but none have completed in the last 15 minutes.
            This may indicate a systemic issue with workflow execution.

  - name: temporal_performance_alerts
    interval: 1m
    rules:
      # Workflow throughput drop
      - alert: WorkflowThroughputDrop
        expr: |
          (rate(temporal_workflows_completed_total[5m]) <
            avg(rate(temporal_workflows_completed_total[1h])[1h:5m]) * 0.5)
        and
          (rate(temporal_workflows_completed_total[5m]) < 10)
        for: 10m
        labels:
          severity: warning
          component: temporal-application
        annotations:
          summary: 'Workflow throughput has dropped significantly'
          description: |
            Current workflow completion rate is less than 50% of the hourly average.
            Workflow Type: {{ $labels.workflow_type }}

      # End-to-end latency high
      - alert: WorkflowEndToEndLatencyHigh
        expr: |
          histogram_quantile(0.99,
            sum(rate(temporal_workflow_end_to_end_latency_seconds_bucket[10m])) by (workflow_type, le)
          ) > 7200
        for: 10m
        labels:
          severity: warning
          component: temporal-application
        annotations:
          summary: 'Workflow end-to-end latency is high'
          description: |
            P99 workflow end-to-end time is above 2 hours.
            Workflow Type: {{ $labels.workflow_type }}

      # Workflow timeout rate increasing
      - alert: WorkflowTimeoutRateIncreasing
        expr: |
          rate(temporal_workflows_timed_out_total[10m]) /
          rate(temporal_workflows_started_total[10m]) > 0.05
        for: 5m
        labels:
          severity: warning
          component: temporal-application
        annotations:
          summary: 'Workflow timeout rate is increasing'
          description: |
            More than 5% of workflows are timing out.
            Workflow Type: {{ $labels.workflow_type }}
            Task Queue: {{ $labels.task_queue }}
