# refine.dev GraphQL Custom Mutations Pattern

**Pattern Date:** 2026-01-24
**Status:** Verified
**Applies to:** `apps/web/src/components/settings/*`, `apps/web/src/components/billing/*`

## Quick Reference

### When to Use

- Custom GraphQL mutations that aren't auto-generated by nestjs-query
- Settings updates, profile changes, password changes, etc.
- Any mutation that requires specific `operation`, `fields`, and `variables` structure

### Code Pattern

```tsx
import { useDataProvider } from '@refinedev/core';
import type { GraphQLMutationConfig } from '@providers/data-provider';

// 1. Get the data provider function and call it
const dp = dataProvider();
if (!dp) throw new Error('Data provider not available');

// 2. Type-safe mutation config
const mutationConfig: GraphQLMutationConfig<YourInputType> = {
  url: '',
  method: 'post',
  config: {
    mutation: {
      operation: 'YourMutationName',
      fields: ['id', 'field1', 'field2'], // Response fields to return
      variables: {
        input: yourDataObject, // Mutation input
      },
    },
  },
};

// 3. Execute (type assertion required due to refine type limitations)
await (dp as any).custom(mutationConfig);
```

## Type Definition

Location: `apps/web/src/providers/data-provider/index.ts`

```tsx
export type GraphQLMutationConfig<TInput = Record<string, unknown>> = {
  url: string;
  method: 'post';
  config: {
    mutation: {
      operation: string;
      fields: string[];
      variables: {
        input: TInput;
      };
    };
  };
};
```

## Common Pitfalls

| ❌ Wrong                            | ✅ Right                            |
| ----------------------------------- | ----------------------------------- |
| `useCustom()` - for queries only    | `useDataProvider()` + `dp.custom()` |
| `config.values`                     | `config.mutation.variables`         |
| `const dp = useDataProvider()`      | `const dp = useDataProvider()()`    |
| Expecting `mutate` from `useCustom` | Using `dp.custom()` directly        |

## Special Handling

### Enum Fields

These fields are NOT quoted in GraphQL (handled automatically by data provider):

- `theme` (SYSTEM, LIGHT, DARK)
- `aiModel` (GPT_4_TURBO, GPT_4, etc.)
- `role` (ADMIN, USER, etc.)

### Empty Strings

Empty string values (`''`) are automatically filtered out from mutation input.

## Example: Settings Preferences

```tsx
import { useDataProvider } from '@refinedev/core';
import type { GraphQLMutationConfig } from '@providers/data-provider';

interface UpdatePreferencesInput {
  locale: string;
  theme: string;
  aiModel: string;
  timezone?: string;
  dateFormat?: string;
}

// In component:
const dp = dataProvider();
if (!dp) throw new Error('Data provider not available');

const mutationConfig: GraphQLMutationConfig<UpdatePreferencesInput> = {
  url: '',
  method: 'post',
  config: {
    mutation: {
      operation: 'updateMyPreferences',
      fields: ['id', 'locale', 'theme', 'aiModel', 'timezone', 'dateFormat'],
      variables: {
        input: data,
      },
    },
  },
};

await (dp as any).custom(mutationConfig);
```

## Related Files

- Type Definition: `apps/web/src/providers/data-provider/index.ts:19-40`
- Example Usage: `apps/web/src/components/settings/settings-preferences.tsx:66-87`
- Documentation: `.automaker/memory/gotchas.md` (see 2026-01-24 entry)
