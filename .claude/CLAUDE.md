# Legal AI Platform - Claude Instructions

## Core Principles

- **Domain-Driven Design (DDD)**: Software model must reflect the legal business domain.
- **Modular Monolith**: Strict boundaries between modules in `apps/backend/src/modules`. No direct imports across modules. Communication via asynchronous events.
- **English-First**: All code, comments, and commit messages in English.
- **Strong Typing**: No `any` (TS) or untyped `Dict`/`Any` (Python).
- **Simplicity**: YAGNI. Concise code. Avoid over-engineering.

## Tech Stack

- **Web**: Next.js, refine.dev, Tailwind CSS, shadcn/ui.
- **Backend**: Nest.js, `@ptc-org/nestjs-query`, GraphQL (Code-First), PostgreSQL.
- **AI Service**: Python, FastAPI, PydanticAI, LangGraph.
- **Package Managers**: `pnpm` (Node), `uv` (Python).

## Build & Development Commands

- **Full Project**:
  - Dev: `pnpm dev`
  - Build: `pnpm build`
  - Lint: `pnpm lint`
  - Format: `pnpm format`
- **Frontend (@legal/web)**: `pnpm dev:web`
- **Backend (@legal/backend)**: `pnpm dev:backend`
- **AI Engine (Python)**:
  - Dev: `uv run dev` (inside `apps/ai-engine`)
  - Test: `uv run pytest`
  - Export OpenAPI: `uv run export-openapi`

## Testing

### Test Commands

- **Monorepo-wide**: `pnpm test`
- **E2E**: `pnpm test:e2e`
- **Integration**: `pnpm test:integration`
- **AI Engine**: `uv run pytest` (inside `apps/ai-engine`)
- **Backend Unit**: `cd apps/backend && jest`
- **Frontend Unit**: `cd apps/web && npm test`
- **Frontend E2E**: `cd apps/web && playwright test`

### Test Structure & Locations

- **Backend Unit Tests**: `apps/backend/src/modules/**/*.spec.ts` - Co-located with source files
- **Backend E2E Tests**: `apps/backend/tests/e2e/*.e2e-spec.ts` - Jest-based API tests
- **Backend Playwright Tests**: `apps/backend/tests/*.spec.ts` - GraphQL API tests
- **Frontend Unit Tests**: `apps/web/src/**/*.spec.tsx` or `apps/web/src/**/__tests__/**/*.spec.tsx` - Jest + React Testing Library
- **Frontend E2E Tests**: `apps/web/tests/*.spec.ts` - Playwright UI tests
- **AI Engine Tests**: `apps/ai-engine/tests/unit/*.py` - Python unit tests

### Frontend Jest Setup (Next.js)

- **Config**: `apps/web/jest.config.ts` (follows [Next.js Jest guide](https://nextjs.org/docs/app/guides/testing/jest))
- **Setup**: `apps/web/jest.setup.ts` - Custom matchers from `@testing-library/jest-dom`
- **Commands**:
  - `cd apps/web && npm test` - Run all tests
  - `cd apps/web && npm run test:watch` - Watch mode
  - `cd apps/web && npm run test:cov` - With coverage
- **Framework**: Jest + React Testing Library
- **Test Patterns**:
  - `src/**/*.spec.tsx` - Test files alongside components
  - `src/**/__tests__/**/*.spec.tsx` - Test files in `__tests__` directories

### Post-Feature Validation Checklist

After completing any feature, ALWAYS run the following validation:

1. **Linting** (via lint-staged on commit, or manually):
   - Backend: `cd apps/backend && pnpm dlx eslint .`
   - Frontend: `cd apps/web && pnpm dlx eslint .`
   - AI Engine: `cd apps/ai-engine && uv run ruff check .`

2. **Type Checking**:
   - Backend: `cd apps/backend && pnpm dlx tsc --noEmit`
   - Frontend: `cd apps/web && pnpm dlx tsc --noEmit`

3. **Run Unit Tests**:
   - Backend: `cd apps/backend && jest`
   - Frontend: `cd apps/web && npm test`
   - AI Engine: `cd apps/ai-engine && uv run pytest`

4. **Run E2E Tests**:
   - Backend: `cd apps/backend && npm run test:e2e`
   - Frontend: `cd apps/web && playwright test`

5. **Run Integration Tests**:
   - Backend: `cd apps/backend && npm run test:integration`

### E2E Test Persistence for Regression Testing

- All Playwright tests (both frontend and backend) should be preserved in `tests/` directories
- Tests serve as regression protection - run full E2E suite before any major release
- Use descriptive test names: `*.spec.ts` files should clearly indicate what feature they validate
- Store test artifacts (screenshots, traces) for CI/CD debugging

### Test Creation Guidelines

- **Backend**: Write `.spec.ts` files alongside entities, services, resolvers
- **Frontend**:
  - **Unit/Component tests**: Create `*.spec.tsx` files in `src/**/__tests__/` or alongside components
  - **E2E tests**: Create Playwright tests in `apps/web/tests/` for UI workflows
  - Use React Testing Library for component testing (Jest)
- **E2E**: Add integration tests in `apps/backend/tests/e2e/` for API endpoints
- **AI Engine**: Write pytest tests in `apps/ai-engine/tests/unit/`

## Coding & Architecture Guidelines

- **Commits**: Follow [Conventional Commits](https://www.conventionalcommits.org/).
- **API Strategy**:
  - Service-to-Service: REST (OpenAPI autogenerated clients).
  - Frontend-Backend: GraphQL exclusively (autogenerated clients). NO REST for frontend.
- **NestJS Query**: Use auto-generated resolvers for standard CRUD. Use custom resolvers ONLY for business logic (AI triggers, etc.).
- **Async Communication**: Use events for cross-module interaction in the backend.
- **SSOT**: Environment variables are the only source for secrets/config.

### refine.dev Custom Mutations (2026-01-24)

When implementing custom GraphQL mutations (settings updates, profile changes), use the data provider's `custom` method directly. The `useCustom` hook is for queries only.

**Pattern:**

```tsx
import { useDataProvider } from '@refinedev/core';
import type { GraphQLMutationConfig } from '@providers/data-provider';

// Get data provider (returns a function)
const dp = dataProvider();
if (!dp) throw new Error('Data provider not available');

// Define mutation config
const mutationConfig: GraphQLMutationConfig<UpdateInputType> = {
  url: '',
  method: 'post',
  config: {
    mutation: {
      operation: 'mutationName',
      fields: ['id', 'field1', 'field2'],
      variables: {
        input: {
          /* data */
        },
      },
    },
  },
};

// Execute mutation (requires type assertion due to refine types)
await (dp as any).custom(mutationConfig);
```

**Key Points:**

- `useDataProvider()` returns a function - must call it: `const dp = dataProvider()`
- `useCustom` hook is for queries (GET) only - returns `{ query, result }`, not `mutate`
- `GraphQLMutationConfig<TInput>` type defined in `apps/web/src/providers/data-provider/index.ts`
- Enum fields (`theme`, `aiModel`, `role`) are not quoted in GraphQL mutation
- Empty string values are filtered out automatically

## Database Seeding

### Seed File Location

Seed data files are located in `apps/backend/src/seeds/data/`:

- `users.seed.ts` - Default users for authentication and testing
- `documents.seed.ts` - Sample legal documents
- `audit-logs.seed.ts` - Sample audit log entries
- `queries.seed.ts` - Sample legal queries
- `rulings.seed.ts` - Sample court rulings
- `sessions.seed.ts` - Sample user sessions
- `analyses.seed.ts` - Sample legal analyses

### Running Seeds

To populate the database with seed data:

```bash
cd apps/backend
pnpm seed
```

### Default Login Credentials

| Email                  | Password      | Role         | Notes                      |
| ---------------------- | ------------- | ------------ | -------------------------- |
| `admin@refine.dev`     | `password`    | Admin        | Primary admin user         |
| `lawyer@example.com`   | `password123` | Lawyer       | Sample lawyer user         |
| `user@example.com`     | `password123` | Regular user | Sample regular user        |
| `inactive@example.com` | `password123` | Inactive     | For testing inactive state |
| `minimal@example.com`  | `password123` | Minimal      | User without username/name |

**Note:** These are development credentials only. Ensure they are not used in production.
